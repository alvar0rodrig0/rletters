#!/usr/bin/env ruby
require 'pathname'
require 'io/console'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

Dir.chdir APP_ROOT do
  puts <<-END
Welcome to RLetters! Thanks for downloading. We'll try to get you set up and
ready to deploy a test environment (or help us out with development!) as fast
as we can.

Requirements:
 - Ruby (the more recent, the better)
 - Local installation of postgres with current user access
 - Java 1.7
 - Maven
Press Ctrl-C to abort, or any other key to continue...
END
  STDIN.getch

  puts "\n== Installing dependencies =="
  system "gem install bundler --conservative"
  system "bundle check || bundle install"

  puts "\n== Checking out sample Solr installation =="
  system "git clone https://github.com/rletters/solr-example.git solr",
         chdir: 'vendor'

  puts "\n== Attempting to build NLP tool (needs Java, Maven) =="
  system "git clone https://github.com/rletters/nlp-tool.git source",
         chdir: 'vendor/nlp'
  system "mvn install", chdir: 'vendor/nlp/source'
  File.open('vendor/nlp/nlp-tool', 'w', 0775) do |f|
    f.write("#!/bin/sh\njava -jar source/nlp-tool-0.1-jar-with-dependencies.jar $@")
  end

  puts "\n==Copying sample files=="
  unless File.exist?("config/database.yml")
    system "cp config/database.yml.local config/database.yml"
  end

  puts "\n== Preparing database =="
  system "bin/rake db:setup"
  system "bin/rake setting:set[nlp_tool_path,vendor/nlp/nlp-tool]"

  puts "\n== Removing old logs and tempfiles =="
  system "rm -f log/*"
  system "rm -rf tmp/cache"

  puts "\n== Starting sample Solr instance =="
  system "./start", chdir: 'vendor/solr'
end
