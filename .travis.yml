sudo: required
dist: trusty

language: ruby
rvm: 2.4.1

cache:
  bundler: true
  directories:
    - node_modules
  yarn: true

# Set the display value and the CodeClimate repository token
env:
  global:
    - TMPDIR=$TRAVIS_BUILD_DIR/tmp
    - DISPLAY=":99.0"
    - DATABASE_URL="postgres:///rletters_test?username=postgres&pool=20&encoding=unicode"
    - secure: Lv1neEs259UnYFTpbBOja4qhbdDnDCryGiZ8ycLkBGlc7PioiSiVqCo1Py+pJrpYenA3xrguv/Z5hdNjJ3fm4dl8GDrV9kgjtNe8E388kitISpimAi5QuwvxfJS8YiRPKm9VSfs3laMlSVXjhMdlAW1PPcrcElddv+r+jMpJ9uM=

# Enable the latest PostgreSQL, and install sdl and sdl_ttf
addons:
  postgresql: 9.6
before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y libsdl1.2-dev libsdl-ttf2.0-dev oracle-java9-installer oracle-java9-set-default

install:
  - git clone --depth=1 https://github.com/rletters/solr-example.git vendor/solr
  - bundle install --without production development --jobs 3 --retry 3
  - nvm install node
  - node -v
  - npm i -g yarn
  - yarn

before_script:
  - sh -e /etc/init.d/xvfb start
  - ln -s .env.example .env
  - 'pushd vendor/solr && ./start && popd'
  - bin/rails RAILS_ENV=test db:setup yarn:install assets:precompile

script:
  - bundle exec rails test
  - bundle exec rails test:system
  - bundle exec codeclimate-test-reporter
